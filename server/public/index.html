<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTU Route AI - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        #map { 
            height: 600px; 
            width: 100%;
            min-height: 600px;
            z-index: 1;
        }
        .leaflet-container {
            height: 100%;
            width: 100%;
        }
        /* Ensure Leaflet controls don't conflict with modal */
        .leaflet-control-layers {
            z-index: 10 !important;
        }
        .leaflet-pane {
            z-index: 5 !important;
        }
        /* Modal styles */
        #poiModal {
            z-index: 9999 !important;
        }
        #poiModal.show {
            display: flex !important;
        }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold">üéì ASTU Route AI</h1>
                    <p class="text-blue-100 text-sm">Admin Dashboard</p>
                </div>
                <div class="flex gap-4">
                    <span class="px-4 py-2 bg-blue-700 rounded-lg" id="serverStatus">
                        <span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                        Server Online
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm uppercase">Campus POIs</p>
                        <p class="text-3xl font-bold text-blue-600" id="poiCount">0</p>
                    </div>
                    <div class="text-4xl">üìç</div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm uppercase">Documents</p>
                        <p class="text-3xl font-bold text-green-600" id="docCount">0</p>
                    </div>
                    <div class="text-4xl">üìö</div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm uppercase">City Services</p>
                        <p class="text-3xl font-bold text-purple-600" id="serviceCount">0</p>
                    </div>
                    <div class="text-4xl">üè™</div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm uppercase">OSM Loaded</p>
                        <p class="text-3xl font-bold text-orange-600" id="osmStatus">No</p>
                    </div>
                    <div class="text-4xl">üó∫Ô∏è</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button class="tab-btn px-6 py-4 text-blue-600 border-b-2 border-blue-600 font-medium" onclick="switchTab('map')">
                        üìç Map View
                    </button>
                    <button class="tab-btn px-6 py-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchTab('pois')">
                        üìç Campus POIs
                    </button>
                    <button class="tab-btn px-6 py-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchTab('documents')">
                        üìö Knowledge Base
                    </button>
                    <button class="tab-btn px-6 py-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchTab('test')">
                        üß™ Test AI
                    </button>
                    <button class="tab-btn px-6 py-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchTab('osm')">
                        üó∫Ô∏è OSM Routes
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Map Tab -->
                <div id="tab-map" class="tab-content">
                    <h3 class="text-xl font-bold mb-4">ASTU Campus Map</h3>
                    <div id="map" class="rounded-lg shadow-md border border-gray-300" style="height: 600px; width: 100%;"></div>
                    <div class="mt-4 bg-blue-50 border-l-4 border-blue-600 p-4">
                        <p class="text-sm text-gray-700">
                            <strong>Map Controls:</strong> Use the layer control (top-right) to switch between Normal, Satellite, and Hybrid views.
                            Click on markers to see POI details.
                        </p>
                    </div>
                </div>

                <!-- POIs Tab -->
                <div id="tab-pois" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Campus POIs Management</h3>
                    </div>
                    
                    <!-- Map for POI Selection -->
                    <div class="mb-6 bg-white rounded-lg shadow-lg border border-gray-300 p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-700">üìç Interactive POI Map</h4>
                            <span class="text-sm text-gray-500 bg-blue-50 px-3 py-1 rounded-full">Click on map to add POI</span>
                        </div>
                        <div id="poiMap" class="rounded-lg border-2 border-gray-200" style="height: 500px; width: 100%; cursor: crosshair;"></div>
                    </div>
                    
                    <!-- POI Modal -->
                    <div id="poiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <!-- Modal Header -->
                            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-2xl flex justify-between items-center">
                                <div>
                                    <h3 id="poiModalTitle" class="text-xl font-bold">üìç New Campus POI</h3>
                                    <p class="text-blue-100 text-sm" id="modalCoordinates">Location: Not selected</p>
                                </div>
                                <button onclick="closeModal()" class="text-white hover:bg-blue-800 rounded-full p-2 transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Modal Body -->
                            <div class="p-6">
                                <input type="hidden" id="poi_id">
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Basic Info -->
                                    <input type="text" id="poi_name" placeholder="Name (e.g., Main Library)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <select id="poi_category" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Select Category</option>
                                        <option value="building">Building</option>
                                        <option value="lab">Laboratory</option>
                                        <option value="office">Office</option>
                                        <option value="classroom">Classroom</option>
                                        <option value="cafeteria">Cafeteria</option>
                                        <option value="library">Library</option>
                                        <option value="gate">Gate</option>
                                        <option value="parking">Parking</option>
                                        <option value="service">Service</option>
                                    </select>
                                    
                                    <!-- Location Details -->
                                    <input type="text" id="poi_building" placeholder="Building Name (optional)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="text" id="poi_block" placeholder="Block Number (e.g., A, B, C)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="number" id="poi_floor" placeholder="Floor Number (optional)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="text" id="poi_room" placeholder="Room Number (e.g., 201, Lab-3)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="number" id="poi_capacity" placeholder="Capacity (optional)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    
                                    <!-- GPS Coordinates -->
                                    <input type="number" step="0.000001" id="poi_lat" placeholder="Latitude (e.g., 8.5569)" class="px-4 py-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500" readonly required>
                                    <input type="number" step="0.000001" id="poi_lng" placeholder="Longitude (e.g., 39.2911)" class="px-4 py-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500" readonly required>
                                    
                                    <!-- Description -->
                                    <textarea id="poi_desc" placeholder="Description (optional)" class="px-4 py-2 border rounded-lg col-span-2 focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                                </div>
                            </div>
                            
                            <!-- Modal Footer -->
                            <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex justify-end gap-3">
                                <button onclick="closeModal()" class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition">
                                    Cancel
                                </button>
                                <button id="savePoiBtn" onclick="savePOI()" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-lg transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span id="savePoiBtnText">Save POI</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="poisList" class="space-y-2">
                        <p class="text-gray-500 text-center py-8">Loading POIs...</p>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="tab-documents" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Knowledge Base Documents</h3>
                        <button onclick="showAddDocForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            + Add Document
                        </button>
                    </div>
                    
                    <!-- Add Document Form -->
                    <div id="addDocForm" class="hidden mb-6 bg-gray-50 p-6 rounded-lg border-2 border-blue-200">
                        <h4 class="font-bold mb-4 text-lg">Add Knowledge Document</h4>
                        <div class="bg-green-50 border-l-4 border-green-500 p-3 mb-4 text-sm">
                            <strong>‚úÖ Auto-Embedding:</strong> When you save this document, the system will automatically:
                            <ul class="list-disc ml-5 mt-1">
                                <li>Generate 1024-dimensional vector embedding using Voyage AI</li>
                                <li>Store in Supabase with pgvector for semantic search</li>
                                <li>Make it instantly searchable via RAG queries</li>
                            </ul>
                        </div>
                        <div class="space-y-4">
                            <input type="hidden" id="doc_id" value="">
                            <input type="text" id="doc_title" placeholder="Title (e.g., Admission Requirements)" class="w-full px-4 py-2 border rounded-lg">
                            <textarea id="doc_content" placeholder="Document content..." class="w-full px-4 py-2 border rounded-lg" rows="6"></textarea>
                            <select id="doc_category" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">Select Category</option>
                                <option value="admission">Admission</option>
                                <option value="academic">Academic</option>
                                <option value="student_services">Student Services</option>
                                <option value="facilities">Facilities</option>
                                <option value="policies">Policies</option>
                            </select>
                            <div class="flex gap-2">
                                <button onclick="addDocument()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                    Save Document
                                </button>
                                <button onclick="hideAddDocForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="docsList" class="space-y-2">
                        <p class="text-gray-500 text-center py-8">Loading documents...</p>
                    </div>
                </div>

                <!-- Test AI Tab -->
                <div id="tab-test" class="tab-content hidden">
                    <h3 class="text-xl font-bold mb-4">Test AI System</h3>
                    
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-4">
                        <div class="space-y-4">
                            <input type="text" id="test_query" placeholder="Ask anything (e.g., Where is the library?)" class="w-full px-4 py-3 border rounded-lg text-lg">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Mode</label>
                                    <select id="test_mode" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="walking">Walking</option>
                                        <option value="taxi">Taxi</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Urgency</label>
                                    <select id="test_urgency" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="normal">Normal</option>
                                        <option value="exam">Exam Mode</option>
                                        <option value="accessibility">Accessibility</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">üìç Your Latitude</label>
                                    <input type="number" step="0.000001" id="test_latitude" placeholder="8.5569 (auto-detect)" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">üìç Your Longitude</label>
                                    <input type="number" step="0.000001" id="test_longitude" placeholder="39.2911 (auto-detect)" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            
                            <button onclick="detectLocation()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mb-2">
                                üìç Auto-Detect My Location
                            </button>
                            
                            <button onclick="testAI()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium text-lg">
                                ü§ñ Test AI System
                            </button>
                        </div>
                    </div>
                    
                    <div id="testResult" class="hidden bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="font-bold text-lg mb-3">üß† AI Reasoning Stream:</h4>
                        <div id="testReasoning" class="text-sm bg-blue-50 p-4 rounded mb-4 max-h-64 overflow-y-auto">
                            <div class="text-gray-500">Waiting for reasoning steps...</div>
                        </div>
                        
                        <h4 class="font-bold text-lg mb-3">üìç Response:</h4>
                        <div id="testAnswer" class="prose max-w-none mb-4"></div>
                        <div id="testIntent" class="text-sm text-gray-600 mb-2"></div>
                        
                        <div id="testRouteViz" class="hidden mt-4">
                            <h4 class="font-bold text-lg mb-3">üó∫Ô∏è Route Visualization:</h4>
                            <div class="text-sm text-gray-600 mb-2">
                                <span id="routeDistance"></span> ‚Ä¢ <span id="routeTime"></span>
                            </div>
                            
                            <!-- Location Tracking Controls -->
                            <div class="flex gap-2 mb-3">
                                <button id="startTrackingBtn" onclick="startTrackingManual()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                    üéØ Start Live Tracking
                                </button>
                                <button id="stopTrackingBtn" onclick="stopLocationTracking()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm hidden">
                                    üõë Stop Tracking
                                </button>
                                <span id="trackingStatus" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hidden">
                                    üìç Tracking active
                                </span>
                            </div>
                            
                            <div id="testRouteMap" class="rounded-lg border-2 border-blue-300 mt-3" style="height: 400px; width: 100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- OSM Routes Tab -->
                <div id="tab-osm" class="tab-content hidden">
                    <h3 class="text-xl font-bold mb-4">OSM Route Testing</h3>
                    
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Start Location</label>
                                <input type="number" step="0.000001" id="osm_start_lat" placeholder="Latitude" value="8.5569" class="w-full px-4 py-2 border rounded-lg mb-2">
                                <input type="number" step="0.000001" id="osm_start_lng" placeholder="Longitude" value="39.2911" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">End Location</label>
                                <input type="number" step="0.000001" id="osm_end_lat" placeholder="Latitude" value="8.5580" class="w-full px-4 py-2 border rounded-lg mb-2">
                                <input type="number" step="0.000001" id="osm_end_lng" placeholder="Longitude" value="39.2920" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <button onclick="testOSMRoute()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium">
                            üó∫Ô∏è Calculate OSM Route
                        </button>
                    </div>
                    
                    <div id="osmResult" class="hidden bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="font-bold text-lg mb-3">Route Details:</h4>
                        <div id="osmRouteInfo"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/admin.js"></script>
</body>
</html>
